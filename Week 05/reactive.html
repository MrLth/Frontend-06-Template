<!--
 * @Author: mrlthf11
 * @LastEditors: mrlthf11
 * @Date: 2020-11-23 21:47:56
 * @LastEditTime: 2020-11-29 19:26:43
 * @Description: file content
-->
<input type="range" max="255" min="0" id="r">
<input type="range" max="255" min="0" id="g">
<input type="range" max="255" min="0" id="b">
<div id="color" style="width:100px;height:100px"></div>
<script>
    const cbs = new Map()
    const reactivates = []

    const effect = cb => {
        reactivates.length = 0
        cb()
        for (const [obj, prop] of reactivates) {
            if (!cbs.has(obj)) {
                cbs.set(obj, new Map())
            }
            if (!cbs.get(obj).has(prop)) {
                cbs.get(obj).set(prop, [])
            }
            cbs.get(obj).get(prop).push(cb)
        }
    }

    const reactive = (object) => new Proxy(object, {
        set(obj, prop, val) {
            obj[prop] = val
            if (cbs.get(obj).get(prop)) {
                for (const cb of cbs.get(obj).get(prop)) {
                    cb()
                }
            }
            return obj[prop]
        },
        get(obj, prop) {
            reactivates.push([obj, prop])
            return obj[prop]
        }
    })

    const p = reactive({
        r: 0,
        g: 0,
        b: 0
    })

    document.getElementById('r').addEventListener('input', (e) => p.r = e.target.value)
    document.getElementById('g').addEventListener('input', (e) => p.g = e.target.value)
    document.getElementById('b').addEventListener('input', (e) => p.b = e.target.value)

    effect(() => {
        document.getElementById('r').value = p.r
    })
    effect(() => {
        document.getElementById('g').value = p.g
    })
    effect(() => {
        document.getElementById('b').value = p.b
    })
    effect(() => {
        document.getElementById('color').style.backgroundColor = `rgb(${p.r},${p.g},${p.b})`
    })

</script>